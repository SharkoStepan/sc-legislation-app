<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестирование</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/test.css') }}">
</head>
<body>
    <header class="header">
        <div class="header__logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="OSTIS Logo">
        </div>
        <nav class="header__nav">
            <a href="{{ url_for('main.requests') }}" class="header__link">Запросы</a>
            <a href="{{ url_for('main.directory') }}" class="header__link">Справочник</a>
            <a href="{{ url_for('main.show_calendar') }}" class="header__link">Календарь</a>
            <a href="{{ url_for('main.forum') }}" class="header__link">Форум</a>
        </nav>
        <div class="header__user">
            <img src="{{ url_for('static', filename='images/user.png') }}" alt="User Icon">
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Стартовый экран -->
            <div id="start-screen" class="screen">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="main-logo">
                </div>
                <h1 class="main-title">Тестирование</h1>
                <p class="subtitle">Пройдите тест для подтверждения квалификации</p>
                <button class="btn btn--primary" onclick="startTest()">Начать тестирование</button>
            </div>

            <!-- Экран вопроса -->
            <div id="question-screen" class="screen" style="display: none;">
                <div class="question-container">
                    <h2 class="question-text" id="question-text"></h2>
                    <div class="answers-list" id="answers-container"></div>
                    <div class="feedback" id="feedback"></div>
                    <button class="btn btn--success" id="btn-submit" style="display: none;" onclick="submitSelectedAnswer()">Отправить ответ</button>
                </div>
            </div>

            <!-- Экран результата -->
            <div id="result-screen" class="screen" style="display: none;">
                <div class="result-container">
                    <h2 class="result-title">Тест завершён!</h2>
                    <p class="result-text">Ваш результат: <span class="result-score" id="final-score">0</span> баллов</p>
                    <button class="btn btn--primary" onclick="goToMain()">На главную</button>
                </div>
            </div>

            <!-- Индикатор загрузки -->
            <div id="loading" class="loading" style="display: none;">
                <div class="loading__spinner"></div>
                <p>Загрузка...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Персональный ассистент по юриспруденции</p>
        <p>Ostis 2025</p>
    </footer>

    <script>
        let currentQuestionId = null;
        let selectedAnswerId = null;

        async function startTest() {
            showLoading();
            try {
                const response = await fetch('/api/test/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('start-screen').style.display = 'none';
                    hideLoading();
                    loadQuestion();
                } else {
                    hideLoading();
                    alert('Ошибка запуска теста: ' + data.message);
                }
            } catch (error) {
                hideLoading();
                console.error('Ошибка при запуске теста:', error);
                alert('Ошибка при запуске теста');
            }
        }

        async function loadQuestion() {
            showLoading();
            clearFeedback();
            selectedAnswerId = null;
            document.getElementById('btn-submit').style.display = 'none';
            
            try {
                const response = await fetch('/api/test/question');
                const data = await response.json();
                
                if (data.success && data.question) {
                    currentQuestionId = data.question.id;
                    displayQuestion(data.question);
                    await loadAnswers(data.question.id);
                    hideLoading();
                } else {
                    hideLoading();
                    finishTest();
                }
            } catch (error) {
                hideLoading();
                console.error('Ошибка загрузки вопроса:', error);
                alert('Ошибка загрузки вопроса');
            }
        }

        function displayQuestion(question) {
            document.getElementById('question-screen').style.display = 'block';
            document.getElementById('question-text').textContent = question.text;
            document.getElementById('answers-container').innerHTML = '';
        }

        async function loadAnswers(questionId) {
            try {
                const response = await fetch('/api/test/answers/' + questionId);
                const data = await response.json();
                
                if (data.success && data.answers) {
                    displayAnswers(data.answers);
                } else {
                    alert('Ошибка загрузки ответов');
                }
            } catch (error) {
                console.error('Ошибка загрузки ответов:', error);
                alert('Ошибка загрузки ответов');
            }
        }

        function displayAnswers(answers) {
            const container = document.getElementById('answers-container');
            container.innerHTML = '';
            
            answers.forEach(function(answer) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-item';
                answerDiv.dataset.answerId = answer.id;
                answerDiv.textContent = answer.text;
                answerDiv.onclick = function() { selectAnswer(answer.id); };
                container.appendChild(answerDiv);
            });
        }

        function selectAnswer(answerId) {
            document.querySelectorAll('.answer-item').forEach(el => el.classList.remove('answer-item--selected'));
            const selected = document.querySelector(`.answer-item[data-answer-id="${answerId}"]`);
            if (selected) selected.classList.add('answer-item--selected');
            
            selectedAnswerId = answerId;
            document.getElementById('btn-submit').style.display = 'inline-block';
        }

        async function submitSelectedAnswer() {
            if (!selectedAnswerId || !currentQuestionId) {
                alert('Пожалуйста, выберите ответ');
                return;
            }
            
            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Отправка...';
            showLoading();
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/test/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: currentQuestionId,
                        answer_id: selectedAnswerId
                    })
                });
                
                const data = await response.json();
                console.log(`[TIMING] Answer submission took ${Date.now() - startTime}ms`);
                
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить ответ';
                
                if (data.success) {
                    showFeedback(data.is_correct);
                    setTimeout(() => loadQuestion(), 1500);
                } else {
                    alert('Ошибка отправки ответа: ' + data.message);
                }
            } catch (error) {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить ответ';
                console.error('Ошибка отправки ответа:', error);
                alert('Ошибка отправки ответа');
            }
        }

        function showFeedback(isCorrect) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = isCorrect ? '✓ Правильно!' : '✗ Неправильно';
            feedback.className = 'feedback ' + (isCorrect ? 'feedback--correct' : 'feedback--incorrect');
            feedback.style.display = 'block';
        }

        function clearFeedback() {
            document.getElementById('feedback').style.display = 'none';
        }

        async function finishTest() {
            document.getElementById('question-screen').style.display = 'none';
            showLoading();
            
            try {
                const response = await fetch('/api/test/finish', { method: 'POST' });
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    document.getElementById('final-score').textContent = data.rating || 0;
                    document.getElementById('result-screen').style.display = 'block';
                } else {
                    alert('Ошибка завершения теста');
                }
            } catch (error) {
                hideLoading();
                console.error('Ошибка завершения теста:', error);
                alert('Ошибка завершения теста');
            }
        }

        function goToMain() {
            window.location.href = "{{ url_for('main.directory') }}";
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
